<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ 2025 å°¾ç‰™éºµé£Ÿå¤§æŠ½ç ğŸ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- è¦–è¦ºè¨­è¨ˆæ¨£å¼ --- */
        :root {
            --primary-color: #b71c1c; /* æ·±ç´… */
            --accent-color: #ffd700; /* é‡‘è‰² */
            --bg-gradient: linear-gradient(135deg, #4a0000 0%, #880e4f 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: #333;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* æ¨™é¡Œå€ */
        header {
            text-align: center;
            padding: 20px;
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        header h1 { margin: 0; font-size: 2.5rem; letter-spacing: 2px; }
        header p { color: #ffecb3; margin-top: 5px; font-size: 1.1rem; }

        /* ä¸»èˆå° (æŠ½çé¡¯ç¤ºå€) */
        .main-stage {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-color);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            width: 90%;
            max-width: 800px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        #result-display {
            font-size: 2.2rem;
            font-weight: bold;
            color: #fff;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            line-height: 1.4;
        }

        #draw-btn {
            background: linear-gradient(to bottom, #ffd700, #ffca28);
            color: #b71c1c;
            border: none;
            padding: 15px 60px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
            margin-top: 20px;
            letter-spacing: 1px;
        }

        #draw-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px #ffd700; }
        #draw-btn:active { transform: scale(0.95); }
        #draw-btn:disabled { background: #ccc; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }

        /* è³‡æ–™å„€è¡¨æ¿ Layout */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            width: 95%;
            max-width: 1400px;
            padding-bottom: 50px;
        }

        .panel {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            height: 450px; /* å›ºå®šé«˜åº¦è®“æ’ç‰ˆæ•´é½Š */
        }

        .panel h2 {
            margin-top: 0;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .count-badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        /* è¼¸å…¥èˆ‡åˆ—è¡¨ */
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        input:focus { border-color: var(--primary-color); }
        
        .add-btn { 
            background: var(--primary-color); color: white; border: none; 
            padding: 0 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.2rem;
        }
        .add-btn:hover { background-color: #8e0000; }

        .list-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            background: #fafafa;
            padding: 5px;
        }
        
        .list-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: white;
            border-left: 3px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .list-item:hover { transform: translateX(3px); border-left-color: var(--primary-color); }
        
        .delete-btn {
            background: transparent; border: none; color: #bbb;
            cursor: pointer; font-size: 1.2rem; padding: 0 8px;
        }
        .delete-btn:hover { color: #d32f2f; }

        /* ä¸­çè€…åˆ—è¡¨ç‰¹åˆ¥æ¨£å¼ */
        .winner-item {
            background: linear-gradient(to right, #fffde7, #fff);
            border-left: 4px solid var(--accent-color);
            color: #e65100;
        }
        .winner-name { font-weight: bold; font-size: 1.1rem; }
        .winner-prize { font-size: 0.85rem; color: #555; margin-top: 2px; }

        /* å·¥å…·æŒ‰éˆ•å€ */
        .tools { margin-bottom: 20px; display: flex; gap: 10px; }
        .tool-btn {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0.9;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .tool-btn:hover { opacity: 1; transform: translateY(-2px); }

        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ 2025 å°¾ç‰™éºµé£Ÿå¤§æŠ½ç</h1>
        <p>é‡‘è›‡å‡ºæ´ â€¢ è²¡æºæ»¾æ»¾ â€¢ å¥½é‹ä¸€æ•´å¹´</p>
    </header>
    
    <div class="tools">
        <button class="tool-btn" onclick="generateMockData()" style="background-color: #009688;">ğŸ› ï¸ ä¸€éµç”¢ç”Ÿæ¸¬è©¦è³‡æ–™</button>
        <button class="tool-btn" onclick="resetDraw()" style="background-color: #607d8b;">ğŸ”„ é‡ç½®æ‰€æœ‰æŠ½ç</button>
    </div>

    <div class="main-stage">
        <div id="result-display">æº–å‚™æŠ½ç...</div>
        <button id="draw-btn">ğŸ”¥ ç«‹å³æŠ½ç ğŸ”¥</button>
    </div>

    <div class="dashboard">
        <div class="panel">
            <h2>
                <span>ğŸ‘¥ å¾…æŠ½åå–®</span>
                <span id="emp-count" class="count-badge">0</span>
            </h2>
            <div class="input-group">
                <input type="text" id="emp-name" placeholder="è¼¸å…¥å“¡å·¥å§“å..." onkeydown="if(event.key==='Enter') addEmployee()">
                <button class="add-btn" onclick="addEmployee()">+</button>
            </div>
            <div id="employee-list" class="list-container">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="panel">
            <h2>
                <span>ğŸ å‰©é¤˜çå“</span>
                <span id="prize-count" class="count-badge">0</span>
            </h2>
            <div class="input-group">
                <input type="text" id="prize-name" placeholder="è¼¸å…¥çå“åç¨±..." onkeydown="if(event.key==='Enter') addPrize()">
                <button class="add-btn" onclick="addPrize()">+</button>
            </div>
            <div id="prize-list" class="list-container">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="panel" style="border-top-color: var(--accent-color);">
            <h2>
                <span>ğŸ† ä¸­çæ¦®è­½æ¦œ</span>
                <span id="winner-count" class="count-badge" style="background: var(--accent-color); color: #b71c1c;">0</span>
            </h2>
            <div id="winner-list" class="list-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, writeBatch, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ä½ çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBxIo8ke76LsbKtc1mnidSyJTMk9iUHtDs",
            authDomain: "project1217-ca157.firebaseapp.com",
            projectId: "project1217-ca157",
            storageBucket: "project1217-ca157.firebasestorage.app",
            messagingSenderId: "120535948758",
            appId: "1:120535948758:web:481a4574f0267215929877"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let employees = [];
        let prizes = [];

        // --- ç›£è½è³‡æ–™åº« ---
        onSnapshot(query(collection(db, "employees")), (snapshot) => {
            employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderEmployees();
            renderWinners();
            updateCounts();
        });

        onSnapshot(query(collection(db, "prizes")), (snapshot) => {
            prizes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPrizes();
            updateCounts();
        });

        // --- æ¸²æŸ“ç•«é¢å‡½å¼ ---
        function renderEmployees() {
            const list = document.getElementById("employee-list");
            const available = employees.filter(e => !e.winner).sort((a, b) => b.timestamp - a.timestamp); // æ–°åŠ å…¥çš„æ’ä¸Šé¢
            
            list.innerHTML = available.map(e => `
                <div class="list-item">
                    <span>${e.name}</span>
                    <button class="delete-btn" onclick="window.deleteData('employees', '${e.id}')">&times;</button>
                </div>
            `).join('');
        }

        function renderPrizes() {
            const list = document.getElementById("prize-list");
            const available = prizes.filter(p => !p.taken).sort((a, b) => b.timestamp - a.timestamp);

            list.innerHTML = available.map(p => `
                <div class="list-item">
                    <span>${p.name}</span>
                    <button class="delete-btn" onclick="window.deleteData('prizes', '${p.id}')">&times;</button>
                </div>
            `).join('');
        }

        function renderWinners() {
            const list = document.getElementById("winner-list");
            // æ‰¾å‡ºå·²ä¸­çè€…ï¼Œä¸¦åè½‰é †åº(æœ€æ–°çš„ä¸­çè€…åœ¨æœ€ä¸Šé¢)
            const winners = employees.filter(e => e.winner).reverse(); 
            
            document.getElementById("winner-count").innerText = winners.length;
            list.innerHTML = winners.map(e => `
                <div class="list-item winner-item">
                    <div>
                        <div class="winner-name">ğŸ‰ ${e.name}</div>
                        <div class="winner-prize">ç²å¾—: ${e.winPrize}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateCounts() {
            const availableEmp = employees.filter(e => !e.winner).length;
            const availablePrz = prizes.filter(p => !p.taken).length;
            document.getElementById("emp-count").innerText = availableEmp;
            document.getElementById("prize-count").innerText = availablePrz;
        }

        // --- è³‡æ–™æ“ä½œ (æ–°å¢/åˆªé™¤) ---
        window.addEmployee = async () => {
            const input = document.getElementById("emp-name");
            if (!input.value.trim()) return;
            await addDoc(collection(db, "employees"), { 
                name: input.value.trim(), winner: false, winPrize: null, timestamp: Date.now() 
            });
            input.value = "";
        }

        window.addPrize = async () => {
            const input = document.getElementById("prize-name");
            if (!input.value.trim()) return;
            await addDoc(collection(db, "prizes"), { 
                name: input.value.trim(), taken: false, timestamp: Date.now() 
            });
            input.value = "";
        }

        window.deleteData = async (col, id) => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ")) {
                await deleteDoc(doc(db, col, id));
            }
        }

        // --- æ ¸å¿ƒï¼šæŠ½çé‚è¼¯èˆ‡ç‰¹æ•ˆ ---
        document.getElementById("draw-btn").addEventListener("click", async () => {
            const btn = document.getElementById("draw-btn");
            const display = document.getElementById("result-display");
            
            const eligiblePeople = employees.filter(e => !e.winner);
            const availablePrizes = prizes.filter(p => !p.taken);

            if (eligiblePeople.length === 0) { alert("ğŸ“‹ æ‰€æœ‰äººéƒ½æœ‰çäº†ï¼æŠ½ççµæŸï¼"); return; }
            if (availablePrizes.length === 0) { alert("ğŸ“¦ çå“å·²ç¶“ç™¼å®Œäº†ï¼"); return; }

            // é–å®šæŒ‰éˆ•
            btn.disabled = true;
            display.style.color = "#fff"; // é‡ç½®é¡è‰²

            // å‹•ç•«è·‘é¦¬ç‡ˆ (æŒçºŒç´„ 2.5 ç§’)
            let counter = 0;
            const interval = setInterval(() => {
                const rName = eligiblePeople[Math.floor(Math.random() * eligiblePeople.length)].name;
                const rPrize = availablePrizes[Math.floor(Math.random() * availablePrizes.length)].name;
                
                display.innerHTML = `<span style="opacity:0.8">${rName}</span><br><span style="font-size:0.6em; opacity:0.6">æ­£åœ¨æŠ½å–...</span>`;
                
                counter++;
                if(counter > 25) { 
                    clearInterval(interval);
                    finalizeDraw(eligiblePeople, availablePrizes);
                }
            }, 80);
        });

        async function finalizeDraw(people, prizePool) {
            // çœŸæ­£éš¨æ©Ÿé¸å‡ºå¾—ä¸»
            const winner = people[Math.floor(Math.random() * people.length)];
            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];

            const display = document.getElementById("result-display");
            display.style.color = "#ffd700"; // é‡‘è‰²å­—é«”
            
            // é¡¯ç¤ºçµæœ
            display.innerHTML = `
                <div style="animation: pop 0.5s;">
                    <div style="font-size:0.6em; color:#fff; margin-bottom:5px;">æ­å–œ</div>
                    ${winner.name} <br>
                    <span style="font-size:0.5em; color:#fff; display:block; margin-top:10px;">ç²å¾— ${prize.name}</span>
                </div>
            `;

            // è§¸ç™¼å½©å¸¶ ğŸ‰
            triggerConfetti();

            // æ›´æ–°è³‡æ–™åº« (Batch å¯«å…¥ç¢ºä¿åŒæ­¥)
            const batch = writeBatch(db);
            const empRef = doc(db, "employees", winner.id);
            const prizeRef = doc(db, "prizes", prize.id);

            batch.update(empRef, { winner: true, winPrize: prize.name });
            batch.update(prizeRef, { taken: true });

            await batch.commit();
            document.getElementById("draw-btn").disabled = false;
        }

        // å½©å¸¶ç‰¹æ•ˆå‡½å¼
        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function(min, max) { return Math.random() * (max - min) + min; }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { return clearInterval(interval); }
                var particleCount = 50 * (timeLeft / duration);
                // å·¦å³å…©é‚Šç™¼å°„
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // --- å·¥å…·ï¼šé‡ç½®èˆ‡å‡è³‡æ–™ç”¢ç”Ÿ ---
        window.resetDraw = async () => {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šé€™æœƒæ¸…é™¤æ‰€æœ‰ä¸­çç‹€æ…‹ï¼Œè®“æ‰€æœ‰äººé‡æ–°æŠ½çï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            
            // é€™è£¡å¦‚æœè³‡æ–™é‡å¾ˆå¤§(>500ç­†)ï¼ŒçœŸå¯¦å°ˆæ¡ˆå»ºè­°åˆ†æ‰¹è™•ç†ï¼Œä½†100-200ç­†å¯ä»¥ç›´æ¥è·‘
            const batch = writeBatch(db);
            employees.forEach(e => batch.update(doc(db, "employees", e.id), { winner: false, winPrize: null }));
            prizes.forEach(p => batch.update(doc(db, "prizes", p.id), { taken: false }));
            await batch.commit();
        }

        // ç”¢ç”ŸçœŸå¯¦å§“åå‡è³‡æ–™
        window.generateMockData = async () => {
            if(!confirm("é€™æœƒå»ºç«‹ 120 ä½è™›æ“¬å“¡å·¥(éš¨æ©ŸçœŸå¯¦å§“å) èˆ‡ 100 ä»½è±ªè¯çå“ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            
            const batch = writeBatch(db);
            
            // 1. å§“ååº«
            const lastNames = ["é™³", "æ—", "é»ƒ", "å¼µ", "æ", "ç‹", "å³", "åŠ‰", "è”¡", "æ¥Š", "è¨±", "é„­", "è¬", "éƒ­", "æ´ª", "æ›¾", "é‚±", "å»–", "è³´", "å¾", "å‘¨", "è‘‰", "è˜‡", "èŠ", "å‘‚", "æ±Ÿ", "ä½•", "è•­", "ç¾…", "é«˜", "æ½˜", "ç°¡", "æœ±", "é¾", "å½­", "æ¸¸", "è©¹", "èƒ¡", "æ–½", "æ²ˆ"];
            const midNames = ["å¿—", "é›…", "æ€¡", "å®¶", "å®—", "ç¾", "æ·‘", "å»º", "ä¿Š", "å† ", "è©©", "æ–‡", "æ¬£", "æƒ ", "ä½©", "ç‰", "ä½³", "å®¶", "æ‰¿", "æ€", "æŸ", "å½¥", "ä¿¡", "å¤§", "å°"];
            const endNames = ["è±ª", "å©·", "å›", "å®", "å‰", "èŠ¬", "ç²", "ç‘‹", "å‡±", "å»·", "æ˜", "è¯", "æ†²", "è³¢", "å®‡", "å®‰", "æ¦®", "è¼", "æˆ", "ç¿°", "ç³", "å„€", "æ½”", "æ¨º", "å€«"];

            function getRandomName() {
                const last = lastNames[Math.floor(Math.random() * lastNames.length)];
                const mid = midNames[Math.floor(Math.random() * midNames.length)];
                const end = endNames[Math.floor(Math.random() * endNames.length)];
                // 10% å–®åï¼Œ90% é›™å
                return Math.random() > 0.1 ? (last + mid + end) : (last + end);
            }

            // 2. å»ºç«‹å“¡å·¥ (ä½¿ç”¨ Set é¿å…é‡è¤‡åå­—)
            let usedNames = new Set();
            let count = 0;
            while(count < 120) {
                let name = getRandomName();
                if(!usedNames.has(name)) {
                    usedNames.add(name);
                    const newRef = doc(collection(db, "employees"));
                    batch.set(newRef, { name: name, winner: false, winPrize: null, timestamp: Date.now() });
                    count++;
                }
            }

            // 3. å»ºç«‹çå“
            const noodleTypes = [
                "ğŸœ A5å’Œç‰›ç´…ç‡’ç‰›è‚‰éºµ", 
                "ğŸ¦€ åŒ—æµ·é“å¸ç‹èŸ¹æ‹‰éºµ", 
                "ğŸ é»‘æ¾éœ²é‡è‡ç‡‰é£¯", 
                "ğŸ¦ æ³¢å£«é “é¾è¦ç¾©å¤§åˆ©éºµ", 
                "ğŸŒ¶ï¸ æ‹›ç‰Œéº»è¾£é´¨è¡€å¯¬ç²‰", 
                "ğŸ² è€æ¯é›å¹²è²ç‡‰é›æ¹¯éºµ", 
                "ğŸœ å† è»æ¸…ç‡‰ç‰›è‚‰éºµ", 
                "ğŸ¥“ æ­£å®—åšå¤šè±šéª¨æ‹‰éºµ", 
                "ğŸ¥¢ å··å£ä¹¾éºµ (å®‰æ…°ç)", 
                "ğŸ“¦ ç¶­åŠ›ç‚¸é†¬éºµä¸€ç®±"
            ];
            
            for(let i=1; i<=100; i++) {
                const newRef = doc(collection(db, "prizes"));
                let pName;
                // å‰3å€‹æ˜¯å¤§ç
                if (i <= 3) pName = `ğŸ‘‘ è‘£äº‹é•·åŠ ç¢¼ - ${noodleTypes[i%3]}`; 
                else pName = noodleTypes[Math.floor(Math.random() * noodleTypes.length)];
                
                batch.set(newRef, { name: pName, taken: false, timestamp: Date.now() });
            }

            await batch.commit();
            alert("âœ… è³‡æ–™å»ºç«‹å®Œæˆï¼æº–å‚™é–‹å§‹æŠ½çï¼");
        }
    </script>
</body>
</html>